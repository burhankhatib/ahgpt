<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üîê Auth Test - Al Hayat GPT Widget</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
            line-height: 1.6;
            color: #333;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        
        .container {
            background: white;
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            margin-bottom: 30px;
        }
        
        h1 {
            color: #2c3e50;
            text-align: center;
            margin-bottom: 30px;
            font-size: 2.5em;
        }
        
        .status {
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            font-weight: 600;
        }
        
        .status.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .status.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .status.loading {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        
        .widget-container {
            border: 3px solid #007bff;
            border-radius: 15px;
            height: 600px;
            overflow: hidden;
            background: #f8f9fa;
            position: relative;
        }
        
        .info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }
        
        .info-card {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            border-left: 4px solid #007bff;
        }
        
        .info-card h3 {
            margin: 0 0 10px 0;
            color: #495057;
        }
        
        .info-card p {
            margin: 5px 0;
            font-size: 0.9em;
        }
        
        .console-output {
            background: #1a1a1a;
            color: #00ff00;
            padding: 20px;
            border-radius: 10px;
            font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
            font-size: 12px;
            height: 200px;
            overflow-y: auto;
            margin: 20px 0;
            border: 2px solid #333;
        }
        
        .test-controls {
            text-align: center;
            margin: 20px 0;
        }
        
        .btn {
            background: #007bff;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            margin: 0 10px;
            font-size: 16px;
            transition: all 0.3s ease;
        }
        
        .btn:hover {
            background: #0056b3;
            transform: translateY(-2px);
        }
        
        .step {
            margin: 15px 0;
            padding: 15px;
            background: #e9ecef;
            border-radius: 8px;
            border-left: 4px solid #007bff;
        }
        
        .step.completed {
            background: #d4edda;
            border-left-color: #28a745;
        }
        
        .step.failed {
            background: #f8d7da;
            border-left-color: #dc3545;
        }
        
        .timestamp {
            font-size: 0.8em;
            color: #666;
            float: right;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîê Clerk Authentication Test</h1>
        
        <div id="status" class="status loading">
            üîÑ Initializing widget and testing authentication...
        </div>
        
        <div class="info-grid">
            <div class="info-card">
                <h3>üìç Current Context</h3>
                <p><strong>Origin:</strong> <span id="current-origin">Loading...</span></p>
                <p><strong>Referrer:</strong> <span id="current-referrer">Loading...</span></p>
                <p><strong>User Agent:</strong> <span id="user-agent">Loading...</span></p>
            </div>
            
            <div class="info-card">
                <h3>üéØ Widget Configuration</h3>
                <p><strong>Source:</strong> auth-test.html</p>
                <p><strong>Height:</strong> 600px</p>
                <p><strong>Theme:</strong> auto</p>
                <p><strong>Guest Mode:</strong> true</p>
            </div>
            
            <div class="info-card">
                <h3>üìä Test Results</h3>
                <p><strong>SDK Load:</strong> <span id="sdk-status">‚è≥ Loading...</span></p>
                <p><strong>Widget Ready:</strong> <span id="widget-status">‚è≥ Waiting...</span></p>
                <p><strong>Auth Issues:</strong> <span id="auth-status">‚è≥ Checking...</span></p>
            </div>
            
            <div class="info-card">
                <h3>‚è±Ô∏è Timing</h3>
                <p><strong>SDK Load Time:</strong> <span id="sdk-time">-</span></p>
                <p><strong>Widget Ready Time:</strong> <span id="widget-time">-</span></p>
                <p><strong>Total Time:</strong> <span id="total-time">-</span></p>
            </div>
        </div>
        
        <div class="test-controls">
            <button class="btn" onclick="reloadWidget()">üîÑ Reload Widget</button>
            <button class="btn" onclick="clearLogs()">üóëÔ∏è Clear Logs</button>
            <button class="btn" onclick="exportLogs()">üìã Export Logs</button>
        </div>
        
        <div id="console-output" class="console-output">
            <div class="timestamp">Console Output</div>
            Initializing authentication test...<br>
        </div>
        
        <div id="test-steps">
            <div class="step" id="step-1">
                <strong>Step 1:</strong> Loading Widget SDK... <span class="timestamp" id="step-1-time"></span>
            </div>
            <div class="step" id="step-2">
                <strong>Step 2:</strong> Creating widget instance... <span class="timestamp" id="step-2-time"></span>
            </div>
            <div class="step" id="step-3">
                <strong>Step 3:</strong> Testing authentication behavior... <span class="timestamp" id="step-3-time"></span>
            </div>
            <div class="step" id="step-4">
                <strong>Step 4:</strong> Verifying no login prompts... <span class="timestamp" id="step-4-time"></span>
            </div>
        </div>
    </div>

    <div class="container">
        <h2>üöÄ Widget Test Area</h2>
        <div id="widget-container" class="widget-container">
            <div style="display: flex; align-items: center; justify-content: center; height: 100%; font-size: 18px; color: #666;">
                üîÑ Loading widget...
            </div>
        </div>
    </div>

    <script>
        const startTime = Date.now();
        let sdkLoadTime = null;
        let widgetReadyTime = null;
        
        // Enhanced logging system
        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const consoleOutput = document.getElementById('console-output');
            const colors = {
                info: '#00ff00',
                warn: '#ffff00',
                error: '#ff0000',
                success: '#00ff88'
            };
            
            const logEntry = `<div style="color: ${colors[type]};">[${timestamp}] ${message}</div>`;
            consoleOutput.innerHTML += logEntry;
            consoleOutput.scrollTop = consoleOutput.scrollHeight;
            
            // Also log to browser console
            console.log(`[AuthTest] ${message}`);
        }
        
        function updateStep(stepNumber, status, message) {
            const step = document.getElementById(`step-${stepNumber}`);
            const time = document.getElementById(`step-${stepNumber}-time`);
            
            step.className = `step ${status}`;
            if (message) {
                step.innerHTML = `<strong>Step ${stepNumber}:</strong> ${message} <span class="timestamp" id="step-${stepNumber}-time">${new Date().toLocaleTimeString()}</span>`;
            }
            time.textContent = new Date().toLocaleTimeString();
        }
        
        function updateStatus(message, type = 'loading') {
            const status = document.getElementById('status');
            status.className = `status ${type}`;
            status.textContent = message;
        }
        
        // Initialize page info
        document.getElementById('current-origin').textContent = window.location.origin;
        document.getElementById('current-referrer').textContent = document.referrer || 'None';
        document.getElementById('user-agent').textContent = navigator.userAgent.substring(0, 100) + '...';
        
        // Widget configuration
        const widgetConfig = {
            containerId: 'widget-container',
            source: 'auth-test.html',
            height: '600px',
            theme: 'auto',
            onReady: function() {
                widgetReadyTime = Date.now();
                const readyTime = widgetReadyTime - startTime;
                
                log(`‚úÖ Widget ready in ${readyTime}ms`, 'success');
                document.getElementById('widget-status').innerHTML = '‚úÖ Ready';
                document.getElementById('widget-time').textContent = `${readyTime}ms`;
                document.getElementById('total-time').textContent = `${readyTime}ms`;
                
                updateStep(2, 'completed', 'Widget instance created successfully');
                updateStep(3, 'completed', 'No authentication issues detected');
                updateStep(4, 'completed', 'Widget running in guest-only mode');
                
                updateStatus('‚úÖ Widget loaded successfully without authentication issues!', 'success');
                
                // Test for any authentication prompts
                setTimeout(() => {
                    checkForAuthPrompts();
                }, 2000);
            },
            onError: function(error) {
                log(`‚ùå Widget error: ${error}`, 'error');
                document.getElementById('widget-status').innerHTML = '‚ùå Error';
                document.getElementById('auth-status').innerHTML = '‚ùå Failed';
                
                updateStep(2, 'failed', `Widget creation failed: ${error}`);
                updateStatus(`‚ùå Widget failed to load: ${error}`, 'error');
            }
        };
        
        // Load widget SDK
        function loadWidget() {
            log('üöÄ Starting widget SDK load...');
            updateStep(1, 'loading', 'Loading Widget SDK...');
            
            // Load the Widget SDK
            const script = document.createElement('script');
            script.src = 'https://www.alhayatgpt.com/widget-sdk-v2.min.js';
            script.onload = function() {
                sdkLoadTime = Date.now();
                const loadTime = sdkLoadTime - startTime;
                
                log(`‚úÖ Widget SDK loaded in ${loadTime}ms`, 'success');
                document.getElementById('sdk-status').innerHTML = '‚úÖ Loaded';
                document.getElementById('sdk-time').textContent = `${loadTime}ms`;
                
                updateStep(1, 'completed', 'Widget SDK loaded successfully');
                updateStep(2, 'loading', 'Creating widget instance...');
                
                // Wait for SDK to be ready
                if (window.AlHayatGPT) {
                    log('üéØ Creating widget instance...');
                    try {
                        window.AlHayatGPT.createWidget(widgetConfig);
                    } catch (error) {
                        log(`‚ùå Error creating widget: ${error}`, 'error');
                        updateStep(2, 'failed', `Error creating widget: ${error}`);
                    }
                } else {
                    log('‚è≥ Waiting for AlHayatGPT SDK to be available...');
                    setTimeout(() => {
                        if (window.AlHayatGPT) {
                            window.AlHayatGPT.createWidget(widgetConfig);
                        } else {
                            log('‚ùå AlHayatGPT SDK not available after timeout', 'error');
                            updateStep(2, 'failed', 'SDK not available after timeout');
                        }
                    }, 1000);
                }
            };
            
            script.onerror = function() {
                log('‚ùå Failed to load Widget SDK', 'error');
                document.getElementById('sdk-status').innerHTML = '‚ùå Failed';
                updateStep(1, 'failed', 'Failed to load Widget SDK');
                updateStatus('‚ùå Failed to load Widget SDK', 'error');
            };
            
            document.head.appendChild(script);
        }
        
        function checkForAuthPrompts() {
            log('üîç Checking for authentication prompts...');
            
            // Check if there are any authentication-related elements
            const iframe = document.querySelector('iframe[src*="widget/chat"]');
            if (iframe) {
                log('‚úÖ Widget iframe found and loaded', 'success');
                document.getElementById('auth-status').innerHTML = '‚úÖ No Issues';
                
                // Additional checks for authentication issues
                setTimeout(() => {
                    try {
                        const iframeDoc = iframe.contentDocument || iframe.contentWindow.document;
                        if (iframeDoc) {
                            const authElements = iframeDoc.querySelectorAll('[class*="clerk"], [class*="auth"], [class*="sign-in"]');
                            if (authElements.length === 0) {
                                log('‚úÖ No authentication elements found in widget', 'success');
                            } else {
                                log(`‚ö†Ô∏è Found ${authElements.length} potential auth elements`, 'warn');
                            }
                        }
                    } catch (e) {
                        log('‚ÑπÔ∏è Cannot access iframe content (normal for cross-origin)', 'info');
                    }
                }, 1000);
            } else {
                log('‚ùå Widget iframe not found', 'error');
                document.getElementById('auth-status').innerHTML = '‚ùå Error';
            }
        }
        
        function reloadWidget() {
            log('üîÑ Reloading widget...');
            const container = document.getElementById('widget-container');
            container.innerHTML = '<div style="display: flex; align-items: center; justify-content: center; height: 100%; font-size: 18px; color: #666;">üîÑ Reloading widget...</div>';
            
            // Reset status
            document.getElementById('sdk-status').innerHTML = '‚è≥ Loading...';
            document.getElementById('widget-status').innerHTML = '‚è≥ Waiting...';
            document.getElementById('auth-status').innerHTML = '‚è≥ Checking...';
            
            // Reset steps
            for (let i = 1; i <= 4; i++) {
                document.getElementById(`step-${i}`).className = 'step';
            }
            
            setTimeout(() => {
                loadWidget();
            }, 500);
        }
        
        function clearLogs() {
            document.getElementById('console-output').innerHTML = '<div class="timestamp">Console Output</div>Console cleared.<br>';
        }
        
        function exportLogs() {
            const logs = document.getElementById('console-output').textContent;
            const blob = new Blob([logs], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `auth-test-logs-${new Date().toISOString().slice(0, 19)}.txt`;
            a.click();
            URL.revokeObjectURL(url);
        }
        
        // Start the test
        document.addEventListener('DOMContentLoaded', function() {
            log('üîê Authentication test initialized');
            loadWidget();
        });
        
        // Monitor for any unexpected redirects
        let originalLocation = window.location.href;
        setInterval(() => {
            if (window.location.href !== originalLocation) {
                log('‚ö†Ô∏è Unexpected page redirect detected!', 'warn');
                originalLocation = window.location.href;
            }
        }, 1000);
    </script>
</body>
</html> 