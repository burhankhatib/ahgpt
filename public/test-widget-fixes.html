<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Widget Fixes Test - Al Hayat GPT</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .test-section {
            background: white;
            margin: 20px 0;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .widget-container {
            height: 600px;
            border: 2px dashed #ccc;
            border-radius: 8px;
            margin: 10px 0;
        }
        .status {
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
        }
        .success { background-color: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .warning { background-color: #fff3cd; color: #856404; border: 1px solid #ffeaa7; }
        .error { background-color: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
    </style>
</head>
<body>
    <h1>🔧 Widget Fixes Test Page</h1>
    <p>This page tests the fixes for widget duplication and authentication 404 issues.</p>
    
    <div class="test-section">
        <h2>Test 1: Single Widget Instance</h2>
        <p>This should load one widget without duplication:</p>
        <div id="widget-test-1" class="widget-container"></div>
        <div id="status-1" class="status">Loading...</div>
    </div>
    
    <div class="test-section">
        <h2>Test 2: Duplicate Prevention</h2>
        <p>This should prevent a second widget from loading in the same container:</p>
        <div id="widget-test-2" class="widget-container"></div>
        <div id="status-2" class="status">Loading...</div>
    </div>
    
    <div class="test-section">
        <h2>Test 3: Multiple Containers</h2>
        <p>Only the first widget should load (singleton guard):</p>
        <div id="widget-test-3a" class="widget-container"></div>
        <div id="widget-test-3b" class="widget-container"></div>
        <div id="status-3" class="status">Loading...</div>
    </div>
    
    <div class="test-section">
        <h2>Fixes Applied</h2>
        <ul>
            <li>✅ <strong>404 Authentication Fix:</strong> Clerk URLs now redirect to main domain</li>
            <li>✅ <strong>Widget Duplication Fix:</strong> Stronger singleton pattern with nesting detection</li>
            <li>✅ <strong>Error Handling:</strong> Better error messages and retry mechanisms</li>
            <li>✅ <strong>Cross-Origin Security:</strong> Enhanced origin validation</li>
        </ul>
    </div>

    <!-- Load SDK -->
    <script src="/widget-sdk.min.js"></script>
    
    <script>
        // Test configuration
        const testConfig = {
            allowGuests: true,
            debug: true,
            onReady: function() {
                console.log('✅ Widget ready');
            },
            onError: function(error) {
                console.error('❌ Widget error:', error.code, error.message);
                if (error.retryable) {
                    console.log('🔄 Will retry automatically');
                }
            }
        };

        // Wait for SDK to load
        function runTests() {
            if (!window.AlHayatGPT) {
                setTimeout(runTests, 100);
                return;
            }

            console.log('🧪 Starting widget tests...');

            // Test 1: Single widget
            try {
                const widget1 = window.AlHayatGPT.createWidget({
                    ...testConfig,
                    containerId: 'widget-test-1',
                    onReady: () => {
                        document.getElementById('status-1').className = 'status success';
                        document.getElementById('status-1').textContent = '✅ Widget 1 loaded successfully';
                        console.log('✅ Test 1 passed: Single widget loaded');
                    },
                    onError: (error) => {
                        document.getElementById('status-1').className = 'status error';
                        document.getElementById('status-1').textContent = `❌ Error: ${error.message}`;
                        console.error('❌ Test 1 failed:', error);
                    }
                });
                console.log('Widget 1 created:', widget1.getInstanceId());
            } catch (error) {
                console.error('❌ Test 1 failed to create widget:', error);
                document.getElementById('status-1').className = 'status error';
                document.getElementById('status-1').textContent = `❌ Creation failed: ${error.message}`;
            }

            // Test 2: Duplicate prevention (same container)
            setTimeout(() => {
                try {
                    const widget2 = window.AlHayatGPT.createWidget({
                        ...testConfig,
                        containerId: 'widget-test-1', // Same container as test 1
                        onReady: () => {
                            document.getElementById('status-2').className = 'status warning';
                            document.getElementById('status-2').textContent = '⚠️ Second widget loaded (unexpected)';
                            console.warn('⚠️ Test 2 partial: Second widget loaded in same container');
                        },
                        onError: (error) => {
                            document.getElementById('status-2').className = 'status success';
                            document.getElementById('status-2').textContent = '✅ Duplicate widget properly prevented';
                            console.log('✅ Test 2 passed: Duplicate widget prevented');
                        }
                    });
                    
                    // If no error thrown, check if it actually prevents duplication
                    setTimeout(() => {
                        const container = document.getElementById('widget-test-1');
                        const iframes = container.querySelectorAll('iframe');
                        if (iframes.length <= 1) {
                            document.getElementById('status-2').className = 'status success';
                            document.getElementById('status-2').textContent = '✅ Duplicate prevention working';
                            console.log('✅ Test 2 passed: Only one iframe in container');
                        }
                    }, 2000);
                    
                } catch (error) {
                    document.getElementById('status-2').className = 'status success';
                    document.getElementById('status-2').textContent = '✅ Duplicate widget properly blocked';
                    console.log('✅ Test 2 passed: Duplicate widget blocked with error');
                }
            }, 1000);

            // Test 3: Multiple containers (singleton guard)
            setTimeout(() => {
                let widgets3Created = 0;
                
                try {
                    const widget3a = window.AlHayatGPT.createWidget({
                        ...testConfig,
                        containerId: 'widget-test-3a',
                        onReady: () => {
                            widgets3Created++;
                            console.log('Widget 3a ready, total widgets:', widgets3Created);
                        }
                    });
                } catch (error) {
                    console.log('Widget 3a blocked:', error.message);
                }

                try {
                    const widget3b = window.AlHayatGPT.createWidget({
                        ...testConfig,
                        containerId: 'widget-test-3b',
                        onReady: () => {
                            widgets3Created++;
                            console.log('Widget 3b ready, total widgets:', widgets3Created);
                        }
                    });
                } catch (error) {
                    console.log('Widget 3b blocked:', error.message);
                }

                // Check results after delay
                setTimeout(() => {
                    const activeCount = window.AlHayatGPT.getActiveWidgetCount();
                    console.log('Active widget count:', activeCount);
                    
                    if (activeCount <= 1) {
                        document.getElementById('status-3').className = 'status success';
                        document.getElementById('status-3').textContent = `✅ Singleton guard working (${activeCount} active widgets)`;
                        console.log('✅ Test 3 passed: Singleton guard working');
                    } else {
                        document.getElementById('status-3').className = 'status warning';
                        document.getElementById('status-3').textContent = `⚠️ Multiple widgets active (${activeCount})`;
                        console.warn('⚠️ Test 3 partial: Multiple widgets active');
                    }
                }, 3000);
            }, 2000);

            // Show active widget count
            setInterval(() => {
                const count = window.AlHayatGPT.getActiveWidgetCount();
                console.log(`📊 Active widgets: ${count}`);
            }, 5000);
        }

        // Start tests when SDK is ready
        window.addEventListener('AlHayatGPTSDKReady', runTests);
        runTests(); // Also try immediately in case already loaded
    </script>
</body>
</html> 