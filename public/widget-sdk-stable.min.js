/*!
 * Al Hayat GPT Widget SDK - Stable Version
 * https://www.alhayatgpt.com
 * 
 * Copyright (c) 2025 Al Hayat GPT
 * Released under the MIT License
 * 
 * This version solves the "refused to connect" issue by:
 * 1. Using popup windows for authentication instead of iframe embedding
 * 2. Implementing robust error handling and fallback mechanisms
 * 3. Adding proper cross-origin support for third-party websites
 */
!function(){"use strict";function t(t,e,i=null){if("undefined"!=typeof console&&console[t]){const n=`[AlHayatGPT SDK Stable] ${(new Date).toISOString()} ${e}`;i?console[t](n,i):console[t](n)}}const e={VERSION:"2.0.0-stable",IFRAME_TIMEOUT:15e3,AUTH_POPUP_TIMEOUT:3e5,RETRY_ATTEMPTS:3,RETRY_DELAY:2e3,MESSAGE_TIMEOUT:3e4,SUPPORTED_THEMES:["light","dark","auto"],DEFAULT_WIDTH:"100%",DEFAULT_HEIGHT:"600px",MIN_HEIGHT:"300px",MAX_HEIGHT:"800px"},i="CONTAINER_NOT_FOUND",n="IFRAME_LOAD_FAILED",s="AUTH_FAILED",a="NETWORK_ERROR",o="TIMEOUT",r="CONFIGURATION_ERROR",h="POPUP_BLOCKED";class c{constructor(i){if(t("info","Widget constructor called",i),!i||!i.containerId){const t=new Error("containerId is required in widget configuration");throw t.type=r,t}this.config={apiEndpoint:"https://www.alhayatgpt.com",theme:"auto",width:e.DEFAULT_WIDTH,height:e.DEFAULT_HEIGHT,allowGuests:!0,retryAttempts:e.RETRY_ATTEMPTS,retryDelay:e.RETRY_DELAY,debug:!1,usePopupAuth:!0,fallbackToGuest:!0,autoResize:!0,secureOrigin:!0,enableRetry:!0,...i},this.validateAndSanitizeConfig(),this.iframe=null,this.container=null,this.messageHandlers=new Map,this.messageEventHandler=null,this.initAttempts=0,this.isDestroyed=!1,this.isReady=!1,this.currentUser=null,this.authPopup=null,this.loadingPromise=null,this.healthCheckInterval=null,this.lastMessageTime=Date.now(),t("info","Widget configuration validated",this.config),this.safeInit()}validateAndSanitizeConfig(){if(e.SUPPORTED_THEMES.includes(this.config.theme)||(t("warn",`Invalid theme "${this.config.theme}", falling back to "auto"`),this.config.theme="auto"),this.config.width&&"number"==typeof this.config.width&&(this.config.width=`${Math.max(200,this.config.width)}px`),this.config.height&&"number"==typeof this.config.height){const t=Math.max(300,Math.min(800,this.config.height));this.config.height=`${t}px`}try{const e=new URL(this.config.apiEndpoint);"https:"!==e.protocol&&"localhost"!==e.hostname&&t("warn","Non-HTTPS endpoint detected, this may cause security issues")}catch(t){const e=new Error(`Invalid apiEndpoint: ${this.config.apiEndpoint}`);throw e.type=r,e}if("string"!=typeof this.config.containerId||!this.config.containerId.trim()){const t=new Error("containerId must be a non-empty string");throw t.type=r,t}}async safeInit(){try{await this.init()}catch(e){t("error","Failed to initialize widget",e),this.handleInitializationFailure(e)}}async init(){if(this.isDestroyed)t("warn","Widget is destroyed, skipping initialization");else{this.initAttempts++,t("info",`Initialization attempt ${this.initAttempts}/${this.config.retryAttempts}`);try{await this.findAndPrepareContainer(),await this.handleAuthenticationFlow(),await this.createWidget(),await this.setupCommunication(),this.finalizeWidget(),t("info","Widget initialization completed successfully"),this.triggerCallback("onReady")}catch(e){if(t("error","Initialization step failed",e),this.config.enableRetry&&this.initAttempts<this.config.retryAttempts)return t("info",`Retrying initialization in ${this.config.retryDelay}ms...`),void setTimeout((()=>this.init()),this.config.retryDelay);throw e}}}async findAndPrepareContainer(){return new Promise(((e,n)=>{const s=()=>{if(this.container=document.getElementById(this.config.containerId),this.container)this.prepareContainer(),t("info","Container found and prepared"),e(this.container);else if("loading"===document.readyState)document.addEventListener("DOMContentLoaded",s,{once:!0}),setTimeout((()=>{if(!this.container){const t=new Error(`Container with ID "${this.config.containerId}" not found after DOM ready`);t.type=i,n(t)}}),5e3);else{const t=new Error(`Container with ID "${this.config.containerId}" not found`);t.type=i,n(t)}};s()}))}prepareContainer(){this.container.style.position&&"static"!==this.container.style.position||(this.container.style.position="relative"),this.showLoadingState()}showLoadingState(){const t=document.createElement("div");if(t.id="ahgpt-loading",t.style.cssText=`\n                display: flex;\n                align-items: center;\n                justify-content: center;\n                height: ${this.config.height};\n                background: #f8fafc;\n                border: 1px solid #e2e8f0;\n                border-radius: 12px;\n                color: #64748b;\n                font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;\n                font-size: 14px;\n            `,t.innerHTML='\n                <div style="text-align: center;">\n                    <div style="width: 40px; height: 40px; border: 3px solid #e2e8f0; border-top: 3px solid #3b82f6; border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto 10px;"></div>\n                    <div>Loading Al Hayat GPT...</div>\n                </div>\n            ',!document.getElementById("ahgpt-loading-styles")){const t=document.createElement("style");t.id="ahgpt-loading-styles",t.textContent="\n                    @keyframes spin {\n                        0% { transform: rotate(0deg); }\n                        100% { transform: rotate(360deg); }\n                    }\n                ",document.head.appendChild(t)}this.container.appendChild(t)}hideLoadingState(){const t=document.getElementById("ahgpt-loading");t&&t.remove()}async handleAuthenticationFlow(){if(!this.config.clerkPublishableKey&&this.config.allowGuests)return t("info","Using guest mode - no authentication required"),null;if(!this.config.clerkPublishableKey)return t("info","No Clerk key provided, using guest mode"),null;t("info","Starting authentication flow");try{const e=this.getStoredAuth();return e&&await this.isAuthValid(e)?(t("info","Using existing valid authentication"),this.currentUser=e,e):this.config.usePopupAuth?await this.authenticateWithPopup():(t("info","Popup auth disabled, falling back to guest mode"),null)}catch(e){if(t("error","Authentication failed",e),this.config.fallbackToGuest)return t("info","Falling back to guest mode"),null;throw e}}async authenticateWithPopup(){return new Promise(((i,n)=>{const a=setTimeout((()=>{this.cleanupAuthPopup();const t=new Error("Authentication timeout");t.type=o,n(t)}),e.AUTH_POPUP_TIMEOUT),r=new URL(`${this.config.apiEndpoint}/sign-in`);r.searchParams.set("widget_auth","true"),r.searchParams.set("parent_origin",window.location.origin);try{if(this.authPopup=window.open(r.toString(),"ahgpt_auth","width=500,height=700,scrollbars=yes,resizable=yes,status=yes,location=yes,toolbar=no,menubar=no"),!this.authPopup||this.authPopup.closed){clearTimeout(a);const t=new Error("Popup was blocked by browser. Please allow popups for authentication.");return t.type=h,void n(t)}const e=o=>{if(this.isValidOrigin(o.origin))if(o.data&&"WIDGET_AUTH_SUCCESS"===o.data.type){clearTimeout(a),window.removeEventListener("message",e);const n=o.data.payload;this.storeAuth(n),this.currentUser=n,this.cleanupAuthPopup(),t("info","Authentication successful",n),i(n)}else if(o.data&&"WIDGET_AUTH_ERROR"===o.data.type){clearTimeout(a),window.removeEventListener("message",e),this.cleanupAuthPopup();const t=new Error(o.data.payload?.message||"Authentication failed");t.type=s,n(t)}};window.addEventListener("message",e);const o=setInterval((()=>{if(this.authPopup&&this.authPopup.closed)if(clearInterval(o),clearTimeout(a),window.removeEventListener("message",e),this.currentUser)i(this.currentUser);else{const t=new Error("Authentication cancelled by user");t.type=s,n(t)}}),1e3)}catch(t){clearTimeout(a),this.cleanupAuthPopup(),t.type=s,n(t)}}))}cleanupAuthPopup(){this.authPopup&&!this.authPopup.closed&&this.authPopup.close(),this.authPopup=null}isValidOrigin(t){try{const e=new URL(t),i=new URL(this.config.apiEndpoint);return e.hostname===i.hostname}catch{return!1}}getStoredAuth(){try{const t=localStorage.getItem("ahgpt_auth");return t?JSON.parse(t):null}catch{return null}}storeAuth(e){try{const t={...e,timestamp:Date.now()};localStorage.setItem("ahgpt_auth",JSON.stringify(t))}catch(e){t("warn","Failed to store auth data",e)}}async isAuthValid(t){if(!t||!t.timestamp)return!1;return!(Date.now()-t.timestamp>864e5)}async createWidget(){return new Promise(((i,s)=>{const a=setTimeout((()=>{const t=new Error("Widget iframe failed to load within timeout");t.type=n,s(t)}),e.IFRAME_TIMEOUT);try{this.iframe=document.createElement("iframe");const e=this.buildWidgetUrl();this.iframe.src=e.toString(),this.iframe.style.cssText=`\n                        width: ${this.config.width};\n                        height: ${this.config.height};\n                        border: none;\n                        border-radius: 12px;\n                        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);\n                        background: white;\n                        display: block;\n                    `,this.iframe.setAttribute("sandbox","allow-scripts allow-same-origin allow-forms allow-popups allow-popups-to-escape-sandbox allow-storage-access-by-user-activation"),this.iframe.setAttribute("allow","clipboard-write; web-share"),this.iframe.setAttribute("loading","eager"),this.iframe.setAttribute("importance","high"),this.iframe.addEventListener("load",(()=>{clearTimeout(a),t("info","Widget iframe loaded successfully"),this.hideLoadingState(),i()})),this.iframe.addEventListener("error",(t=>{clearTimeout(a);const e=new Error("Failed to load widget iframe");e.type=n,e.originalEvent=t,s(e)})),this.container.appendChild(this.iframe)}catch(t){clearTimeout(a),t.type=n,s(t)}}))}buildWidgetUrl(){const t=new URL(`${this.config.apiEndpoint}/widget/chat`);return t.searchParams.set("theme",this.config.theme),t.searchParams.set("allowGuests",this.config.allowGuests.toString()),t.searchParams.set("parentOrigin",window.location.origin),t.searchParams.set("version",e.VERSION),this.currentUser&&(t.searchParams.set("authenticated","true"),t.searchParams.set("userId",this.currentUser.id||"")),this.config.debug&&t.searchParams.set("debug","true"),t}async setupCommunication(){return new Promise(((t,i)=>{const n=setTimeout((()=>{const t=new Error("Widget failed to become ready within timeout");t.type=o,i(t)}),e.MESSAGE_TIMEOUT);this.messageEventHandler=t=>{this.handleMessage(t)},window.addEventListener("message",this.messageEventHandler),this.once("WIDGET_READY",(()=>{clearTimeout(n),this.isReady=!0,this.startHealthCheck(),t()})),this.once("ERROR",(t=>{clearTimeout(n);const e=new Error(t?.message||"Widget reported an error");e.type=a,i(e)}))}))}handleMessage(e){if(!this.isValidOrigin(e.origin))return void t("warn","Ignored message from invalid origin",e.origin);const i=e.data;if(i&&i.type){switch(this.lastMessageTime=Date.now(),t("debug","Received message",i),i.type){case"WIDGET_READY":t("info","Widget ready signal received");break;case"USER_SIGNED_IN":this.currentUser=i.payload,this.storeAuth(i.payload),this.triggerCallback("onUserSignIn",i.payload);break;case"USER_SIGNED_OUT":this.currentUser=null,localStorage.removeItem("ahgpt_auth"),this.triggerCallback("onUserSignOut");break;case"RESIZE":if(this.config.autoResize&&this.iframe&&i.payload?.height){const t=Math.max(300,Math.min(800,i.payload.height));this.iframe.style.height=`${t}px`}break;case"ERROR":const e=new Error(i.payload?.message||"Widget error");e.type=a,this.triggerCallback("onError",e)}this.triggerEventHandlers(i.type,i.payload)}}triggerEventHandlers(e,i){(this.messageHandlers.get(e)||[]).forEach((e=>{try{e(i)}catch(e){t("error","Event handler error",e)}}))}triggerCallback(e,...i){if(this.config[e]&&"function"==typeof this.config[e])try{this.config[e](...i)}catch(i){t("error",`Callback ${e} error`,i)}}startHealthCheck(){this.healthCheckInterval=setInterval((()=>{Date.now()-this.lastMessageTime>6e4&&t("warn","Widget may be unresponsive - no messages received recently")}),3e4)}finalizeWidget(){this.applyCustomStyles(),this.isReady=!0,t("info","Widget finalization complete")}applyCustomStyles(){if(this.config.customStyles&&this.container)try{Object.assign(this.container.style,this.config.customStyles)}catch(e){t("warn","Failed to apply custom styles",e)}}handleInitializationFailure(e){t("error","Widget initialization failed completely",e),this.hideLoadingState(),this.container&&this.showErrorState(e),this.triggerCallback("onError",e)}showErrorState(t){const e=document.createElement("div");e.style.cssText=`\n                display: flex;\n                flex-direction: column;\n                align-items: center;\n                justify-content: center;\n                height: ${this.config.height};\n                background: #fef2f2;\n                border: 1px solid #fecaca;\n                border-radius: 12px;\n                color: #991b1b;\n                font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;\n                font-size: 14px;\n                text-align: center;\n                padding: 20px;\n            `;const i=t.type===h,s=t.type===a||t.type===n;let o="Unable to load chatbot",r="Please try refreshing the page.";i?(o="Authentication blocked",r="Please allow popups and try again, or use guest mode."):s&&(o="Connection error",r="Please check your internet connection and try again."),e.innerHTML=`\n                <div style="font-size: 24px; margin-bottom: 10px;">⚠️</div>\n                <div style="font-weight: 600; margin-bottom: 8px;">${o}</div>\n                <div style="color: #7f1d1d; margin-bottom: 16px;">${r}</div>\n                ${this.config.allowGuests&&!i?'<button style="background: #dc2626; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer;" onclick="location.reload()">Try Again</button>':""}\n            `,this.container.innerHTML="",this.container.appendChild(e)}on(t,e){if("function"!=typeof e)throw new Error("Event handler must be a function");return this.messageHandlers.has(t)||this.messageHandlers.set(t,[]),this.messageHandlers.get(t).push(e),this}once(t,e){const i=n=>{e(n),this.off(t,i)};return this.on(t,i)}off(t,e){const i=this.messageHandlers.get(t);if(i){const t=i.indexOf(e);t>-1&&i.splice(t,1)}return this}sendMessage(e,i){if(!this.iframe||!this.iframe.contentWindow)return void t("warn","Cannot send message - iframe not ready");const n={type:e,payload:i,timestamp:Date.now(),source:"widget-sdk"};try{this.iframe.contentWindow.postMessage(n,this.config.apiEndpoint),t("debug","Sent message to widget",n)}catch(e){t("error","Failed to send message to widget",e)}}updateConfig(t){if(!t||"object"!=typeof t)throw new Error("updateConfig requires a configuration object");const e={...this.config};return this.config={...this.config,...t},t.theme&&t.theme!==e.theme&&this.sendMessage("UPDATE_CONFIG",{theme:t.theme}),t.height&&t.height!==e.height&&this.iframe&&(this.iframe.style.height=t.height),t.customStyles&&this.applyCustomStyles(),this}signIn(){return this.currentUser?(t("warn","User is already signed in"),Promise.resolve(this.currentUser)):this.authenticateWithPopup()}signOut(){return this.currentUser=null,localStorage.removeItem("ahgpt_auth"),this.sendMessage("SIGN_OUT"),this.triggerCallback("onUserSignOut"),this}getUser(){return this.currentUser}isAuthenticated(){return!!this.currentUser}isWidgetReady(){return this.isReady}getVersion(){return e.VERSION}destroy(){t("info","Destroying widget"),this.isDestroyed=!0,this.isReady=!1,this.healthCheckInterval&&(clearInterval(this.healthCheckInterval),this.healthCheckInterval=null),this.cleanupAuthPopup(),this.messageEventHandler&&(window.removeEventListener("message",this.messageEventHandler),this.messageEventHandler=null),this.iframe&&(this.iframe.remove(),this.iframe=null),this.messageHandlers.clear(),this.container&&(this.container.innerHTML=""),t("info","Widget destroyed successfully")}}const l={createWidget(e){try{return new c(e)}catch(e){throw t("error","Failed to create widget",e),e}},version:e.VERSION,isSupported:()=>!!(window.postMessage&&window.addEventListener&&document.createElement&&localStorage&&URL&&Promise),validateConfig(t){if(!t)throw new Error("Configuration is required");if(!t.containerId)throw new Error("containerId is required");return!0}};window.AlHayatGPT=l,"function"==typeof window.CustomEvent&&window.dispatchEvent(new CustomEvent("AlHayatGPTSDKReady",{detail:l})),t("info",`Al Hayat GPT Widget SDK ${e.VERSION} loaded successfully`)}();